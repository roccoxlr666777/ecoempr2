<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Gerencial UDAL | Microeconomía</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #D4AF37;       
            --primary-dark: #aa8c2c;  
            --bg: #000000;            
            --card-bg: #111111;       
            --text-main: #f0f0f0;     
            --text-muted: #aaaaaa;    
            --success: #2e7d32;       
            --danger: #c62828;        
            --shadow: 0 10px 40px rgba(212, 175, 55, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* HUD */
        .hud {
            width: 100%; padding: 15px 5%; 
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 2px solid var(--primary); 
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        .brand { font-weight: 700; color: var(--primary); font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; }
        .capital-pill { 
            background: linear-gradient(45deg, var(--primary-dark), var(--primary)); 
            color: #000; padding: 10px 25px; 
            border-radius: 4px; font-weight: 800; font-size: 1.1rem;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        /* CONTAINER */
        .main-container { width: 95%; max-width: 900px; margin: 40px auto 80px; }

        .phase-card {
            background: var(--card-bg); border-radius: 8px; padding: 40px;
            box-shadow: var(--shadow); border: 1px solid #333;
            display: none; animation: fadeIn 0.5s ease;
        }
        .phase-card.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { color: var(--primary); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        h2 { font-size: 1.5rem; border-bottom: 1px solid var(--primary-dark); display: inline-block; padding-bottom: 10px; margin-bottom: 25px; }
        p { line-height: 1.6; color: var(--text-main); margin-bottom: 20px; }
        
        .phase-logic {
            background: rgba(212, 175, 55, 0.1); border: 1px solid var(--primary-dark);
            padding: 15px; margin-bottom: 25px; border-radius: 4px;
            color: #e0e0e0; font-size: 0.95rem;
        }
        .phase-logic strong { color: var(--primary); text-transform: uppercase; }

        .narrative { 
            background: #222; padding: 20px; border-left: 4px solid var(--primary); 
            margin-bottom: 25px; font-style: italic; color: #ccc;
        }

        /* INPUTS & BUTTONS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

        .btn {
            background: var(--primary); color: #000; border: none; padding: 18px; width: 100%;
            border-radius: 4px; font-weight: 800; text-transform: uppercase; cursor: pointer; 
            transition: 0.3s; margin-top: 15px; letter-spacing: 1px;
        }
        .btn:hover:not(:disabled) { background: #fff; box-shadow: 0 0 15px var(--primary); }
        .btn:disabled { background: #333; color: #555; cursor: not-allowed; border: 1px solid #444; }

        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background: var(--primary); color: #000; }
        
        .btn-whatsapp { background: #25D366; color: white; margin-top: 20px; }
        .btn-whatsapp:hover { background: #128C7E; box-shadow: 0 0 15px #25D366; }

        input, select {
            width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: var(--primary);
            border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 1rem; margin-bottom: 15px;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }

        .card-option {
            border: 1px solid #333; padding: 25px; border-radius: 6px; cursor: pointer;
            transition: 0.3s; position: relative; background: #0a0a0a;
        }
        .card-option:hover { border-color: var(--primary); background: #1a1a1a; transform: translateY(-2px); }
        .card-option.selected { border: 2px solid var(--primary); background: #1a1a1a; }
        .card-option h3 { color: var(--primary); margin: 0 0 5px 0; font-size: 1.1rem; }
        .card-option small { color: #888; display: block; margin-top: 5px; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #111; padding: 40px; border-radius: 8px; text-align: center;
            max-width: 500px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); 
            border: 1px solid var(--primary);
        }
        .modal-box h2 { color: var(--primary); margin-bottom: 15px; }
        .modal-box p { color: #ddd; font-size: 1.1rem; }
        .math-display { font-family: 'Courier New', monospace; color: #0f0; background: #000; padding: 10px; margin: 10px 0; }

        /* PRINT STYLES */
        #diploma-container { display: none; }
        @media print {
            body * { visibility: hidden; }
            #diploma-container, #diploma-container * { visibility: visible; }
            #diploma-container {
                position: absolute; top: 0; left: 0; width: 100%;
                display: flex !important; flex-direction: column; align-items: center;
                background: white; color: black; padding: 20px;
            }
            .no-print { display: none !important; }
            .diploma-paper { 
                border: 10px double #000; width: 100%; max-width: 800px; 
                padding: 40px; text-align: center; position: relative; margin-bottom: 30px;
            }
            .stamp { opacity: 1 !important; }
        }

        .stamp {
            position: absolute; bottom: 50px; right: 50px; width: 140px; height: 140px;
            border: 5px solid; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: 900; transform: rotate(-20deg); opacity: 0.9;
        }
        .stamp-pass { color: var(--success) !important; border-color: var(--success) !important; }
        .stamp-fail { color: var(--danger) !important; border-color: var(--danger) !important; }
    </style>
</head>
<body>

    <div class="hud no-print">
        <div class="brand">UDAL | GERENCIA</div>
        <div class="capital-pill"><i class="fas fa-coins"></i> $<span id="hud-cap">0</span></div>
    </div>

    <div class="main-container no-print">

        <div id="p0" class="phase-card active">
            <h1>Simulador Gerencial</h1>
            <p>Bienvenido a la evaluación práctica de Microeconomía.</p>
            <div class="phase-logic">
                <strong>Regla de Oro:</strong> El capital es vida. Si en cualquier momento tu saldo es negativo, reprobarás automáticamente. No hay decimales, todo se redondea.
            </div>
            <label>Nombre del Gerente:</label>
            <input type="text" id="in-name" placeholder="Ingresa tu nombre completo">
            <button class="btn" onclick="startSim()">Iniciar Evaluación</button>
        </div>

        <div id="p1" class="phase-card">
            <h2>Fase 1: Capital Intelectual</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Antes de recibir capital financiero, debes demostrar capital intelectual. Cada respuesta correcta genera $500 de capital semilla.
            </div>
            <p>30 preguntas. <span style="color:var(--primary); font-weight:bold;">$500</span> por acierto.</p>
            <div class="narrative" id="p1-q">Pregunta...</div>
            <div id="p1-opts" class="grid-2"></div>
        </div>

        <div id="p2" class="phase-card">
            <h2>Fase 2: Gestión de Riesgos</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Un gerente debe decidir entre costos fijos seguros o variables riesgosos.
                <br>• $0: Alto Riesgo (Perder $100 o Ganar $50).
                <br>• $50: Seguro (Sin pérdidas ni ganancias extra).
                <br>• $100: Inversión (Riesgo bajo de perder $50 o Ganar $100).
            </div>
            <div class="narrative" id="p2-story">Historia...</div>
            <div id="p2-opts" class="grid-3"></div>
        </div>

        <div id="p3" class="phase-card">
            <h2>Fase 3: Portafolio</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> El costo unitario (CTU) depende del riesgo del modelo de negocio. No puedes invertir más del 50% de tu capital acumulado.
            </div>
            <p>Selecciona tu modelo de negocio:</p>
            <div class="grid-3">
                <div class="card-option" onclick="selectBiz(0)"><h3>Gestoría</h3><small>Riesgo Bajo (CTU $5)</small></div>
                <div class="card-option" onclick="selectBiz(1)"><h3>Alimentos</h3><small>Riesgo Medio (CTU $10)</small></div>
                <div class="card-option" onclick="selectBiz(2)"><h3>Tecnología</h3><small>Riesgo Alto (CTU $15)</small></div>
            </div>
            <div id="p3-invest" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                <label>Capital a invertir (Máx 50%):</label>
                <input type="range" id="inv-slider" min="10" max="50" value="25" oninput="updInv()">
                <p>Invirtiendo: <strong>$<span id="inv-amt">0</span></strong> (<span id="inv-pct">25</span>%)</p>
                <p style="font-size:0.8rem; color:#888;">*Se ajustarán unidades a enteros y se devolverá el cambio.</p>
                <button class="btn" onclick="confirmInvest()">Confirmar Inversión</button>
            </div>
        </div>

        <div id="p35" class="phase-card">
            <h2>Fase 3.5: Auditoría SAT</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> La clasificación incorrecta de costos genera multas que afectan la liquidez.
            </div>
            <div class="narrative">Clasifica los costos correctamente (Fijo/Variable).</div>
            <div id="cost-area"></div>
            <button class="btn" onclick="validateCosts()">Presentar Declaración</button>
        </div>

        <div id="p4" class="phase-card">
            <h2>Fase 4: Estrategia de Precios</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> El precio debe cubrir costos y generar margen.
            </div>
            <p>Producción: <strong><span id="p4-u"></span> u.</strong> | CTU: <strong>$<span id="p4-ctu"></span></strong>.</p>
            <label>Margen de Ganancia Deseado (%):</label>
            <input type="number" id="p4-margin" placeholder="Ej. 30" step="1">
            <button class="btn" onclick="calcPrice()">Calcular Precio</button>
        </div>

        <div id="p5" class="phase-card">
            <h2>Fase 5: Investigación de Mercado</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> La información precisa cuesta dinero. Operar a ciegas es gratis pero arriesgado.
                <br>• Consultar Experto: $1,000.
            </div>
            <div class="narrative">Tu Precio Calculado: <strong>$<span id="p5-price"></span></strong>. Capital Actual: $<span id="p5-cap"></span>.</div>
            <div class="grid-2">
                <button class="btn" id="btn-expert" onclick="hireExpert(true)">Contratar Experto (-$1,000)</button>
                <button class="btn btn-outline" onclick="hireExpert(false)">Operar a Ciegas (Gratis)</button>
            </div>
        </div>

        <div id="p5b" class="phase-card">
            <h2>Fase 5b: Decisión de Mercado</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> El mercado tiene sus propias reglas. Si tus precios no coinciden con el equilibrio, perderás ventas.
            </div>
            <div id="expert-report" style="background:#222; padding:15px; margin-bottom:15px; border:1px solid #444;"></div>
            
            <label>Acción a tomar:</label>
            <div class="grid-3">
                <button class="btn btn-outline" onclick="marketAction('keep')">Mantener mi Precio</button>
                <button class="btn btn-outline" onclick="showManualPrice()">Fijar Nuevo Precio Manual</button>
                <button class="btn" id="btn-eq" onclick="marketAction('eq')">Ajustar al Equilibrio ($500)</button>
            </div>

            <div id="manual-price-area" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:15px;">
                <label>Nuevo Precio Manual:</label>
                <input type="number" id="manual-price-in">
                <button class="btn" onclick="marketAction('manual')">Confirmar Precio</button>
            </div>
        </div>

        <div id="p6" class="phase-card">
            <h2>Fase 6: Elasticidades</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Comprender la sensibilidad del cliente maximiza ingresos. <br><span style="color:var(--danger)">Cuidado: Cada respuesta incorrecta en esta fase y posteriores restará $1,000.</span>
            </div>
            <div id="elast-area"></div>
        </div>

        <div id="p7" class="phase-card">
            <h2>Fase 7: Entorno y Ubicación</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Los determinantes de la oferta y la demanda definen el éxito del negocio.
            </div>
            <div class="grid-2">
                <div>
                    <h4 style="color:var(--text-muted)">Determinantes de la Demanda</h4>
                    <div class="card-option" id="loc-a1" onclick="selLoc('a',1)">
                        <h3>CDMX</h3>
                        <small>"Se espera un alza de precios a futuro"</small>
                    </div>
                    <div class="card-option" style="margin-top:10px" id="loc-a2" onclick="selLoc('a',2)">
                        <h3>Puebla</h3>
                        <small>"El bien ha pasado de moda"</small>
                    </div>
                    <div class="card-option" style="margin-top:10px" id="loc-a3" onclick="selLoc('a',3)">
                        <h3>Jalisco</h3>
                        <small>"Disminución de consumidores"</small>
                    </div>
                </div>
                <div>
                    <h4 style="color:var(--text-muted)">Determinantes de la Oferta</h4>
                    <div class="card-option" id="loc-b1" onclick="selLoc('b',1)">
                        <h3>Veracruz</h3>
                        <small>"Se aprobará una ley que prohiba sustitutos"</small>
                    </div>
                    <div class="card-option" style="margin-top:10px" id="loc-b2" onclick="selLoc('b',2)">
                        <h3>Oaxaca</h3>
                        <small>"El precio de la tecnología aumentó"</small>
                    </div>
                    <div class="card-option" style="margin-top:10px" id="loc-b3" onclick="selLoc('b',3)">
                        <h3>Chiapas</h3>
                        <small>"El número de productores aumentó"</small>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="checkLocation()">Establecer Sede</button>
        </div>

        <div id="p8" class="phase-card">
            <h2>Fase 8: Isocostos (Optimización)</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Optimización de recursos bajo restricción presupuestaria.
            </div>
            <p>Presupuesto Productivo: <strong>$<span id="p8-budget"></span></strong></p>
            <div class="grid-3">
                <div><label>Tierra ($20,000)</label><input type="number" id="inp-t" value="0"></div>
                <div><label>Maquinaria ($10,000)</label><input type="number" id="inp-k" value="0"></div>
                <div><label>Trabajo ($5,000)</label><input type="number" id="inp-w" value="0"></div>
            </div>
            <button class="btn" onclick="checkFactors()">Comprar Factores</button>
        </div>

        <div id="p8b" class="phase-card">
            <h2>Ajuste RMST</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Sustitución de factores ante escasez manteniendo la producción.
            </div>
            <div class="narrative"><span style="color:var(--danger)">¡ALERTA!</span> Se agotó la Tierra disponible. RMST: 1 Tierra = 2 Máquinas. Realiza la sustitución técnica.</div>
            <div class="grid-2">
                <div><label>Nueva Tierra (Debe ser 0)</label><input type="number" id="adj-t" value="0"></div>
                <div><label>Nueva Maquinaria (K)</label><input type="number" id="adj-k"></div>
            </div>
            <button class="btn" onclick="checkAdjust()">Confirmar Ajuste</button>
        </div>

        <div id="p9" class="phase-card">
            <h2>Fase 9: Consumidor</h2>
            <div class="phase-logic">
                <strong>Lógica del Problema:</strong> Distribución racional del ingreso neto.
            </div>
            <p>Capital Total: <strong>$<span id="p9-total"></span></strong></p>
            <label>1. Consumo (Min 30%):</label><input type="number" id="d-cons">
            <label>2. Ahorro:</label><input type="number" id="d-save">
            <label>3. Inversión:</label><input type="number" id="d-inv">
            <button class="btn" onclick="checkDist()">Siguiente</button>
        </div>

        <div id="p9b" class="phase-card">
            <h2>Restricción Presupuestaria</h2>
            <p>Presupuesto Consumo: $<span id="p9-cons-bd"></span></p>
            <p>Precios: Papas $20 | Refrescos $10</p>
            <label>Máx Papas (si solo compras papas):</label><input type="number" id="r-max-p">
            <label>Máx Refrescos (si solo compras refrescos):</label><input type="number" id="r-max-s">
            <button class="btn" onclick="checkIntercepts()">Validar</button>
        </div>

        <div id="p9c" class="phase-card">
            <h2>Canasta Óptima</h2>
            <p>Gasta exactamente tu presupuesto.</p>
            <div class="grid-2">
                <div><label>U. Papas</label><input type="number" id="c-papas"></div>
                <div><label>U. Refresco</label><input type="number" id="c-soda"></div>
            </div>
            <button class="btn" onclick="checkBasket()">Comprar</button>
        </div>

        <div id="p9d" class="phase-card">
            <h2>Tasa Marginal de Sustitución</h2>
            <div class="phase-logic">
                <strong>Lógica:</strong> Relación de precios Px/Py (20/10).
            </div>
            <div class="narrative">Si dejas de comprar 1 Papa, ¿cuántos Refrescos puedes añadir a la canasta sin gastar más?</div>
            <div class="grid-3">
                <button class="btn btn-outline" onclick="checkRMS(1)">1 Refresco</button>
                <button class="btn btn-outline" onclick="checkRMS(2)">2 Refrescos</button>
                <button class="btn btn-outline" onclick="checkRMS(0.5)">Media Papa</button>
            </div>
        </div>

        <div id="pEnd" class="phase-card" style="text-align: center;">
            <i class="fas fa-flag-checkered" style="font-size: 4rem; color: var(--primary);"></i>
            <h2>Evaluación Finalizada</h2>
            <button class="btn" onclick="window.print()">Descargar Diploma</button>
            <button class="btn btn-whatsapp" onclick="sendWhatsapp()"><i class="fab fa-whatsapp"></i> Enviar a WhatsApp</button>
        </div>

        <div id="pFail" class="phase-card" style="text-align: center; border-color: var(--danger);">
            <i class="fas fa-skull-crossbones" style="font-size: 4rem; color: var(--danger);"></i>
            <h2 style="color:var(--danger)">BANCARROTA</h2>
            <p>Has perdido todo el capital. Tu gestión ha sido deficiente.</p>
            <button class="btn" style="background:var(--danger); color:white;" onclick="window.print()">Ver Certificado de Reprobación</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h2 id="m-title"></h2>
            <p id="m-msg"></p>
            <button class="btn" id="m-btn">Continuar</button>
        </div>
    </div>

    <div id="diploma-container">
        <div class="diploma-paper">
            <h1 style="font-family:'Times New Roman'; text-transform:uppercase; font-size:2rem; margin-bottom:5px;">Universidad de América Latina</h1>
            <h3 style="text-transform:uppercase; font-size:1rem; letter-spacing:3px; margin-top:0;">Dirección Académica</h3>
            
            <p style="font-size:1.2rem; margin-top:40px;">Hace constar los resultados del Gerente:</p>
            <h2 style="font-family:'Times New Roman'; font-size:2.5rem; border-bottom:2px solid #000; padding:10px 40px; margin:20px 0;" id="dip-name"></h2>
            
            <table style="width:80%; margin:30px auto; font-size:1.2rem; border-collapse:collapse;">
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="text-align:left; padding:10px;">Aciertos Teóricos:</td>
                    <td style="text-align:right; font-weight:bold;"><span id="dip-score"></span> / 30</td>
                </tr>
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="text-align:left; padding:10px;">Aciertos Totales (Global):</td>
                    <td style="text-align:right; font-weight:bold;"><span id="dip-glob-ok"></span></td>
                </tr>
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="text-align:left; padding:10px;">Errores Totales (Global):</td>
                    <td style="text-align:right; font-weight:bold; color:var(--danger);"><span id="dip-glob-fail"></span></td>
                </tr>
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="text-align:left; padding:10px;">Calificación (Escala 10):</td>
                    <td style="text-align:right; font-weight:bold; font-size:1.4rem;"><span id="dip-grade"></span></td>
                </tr>
                <tr style="border-bottom:1px solid #ccc;">
                    <td style="text-align:left; padding:10px;">Capital Final:</td>
                    <td style="text-align:right;">$<span id="dip-final"></span></td>
                </tr>
            </table>

            <div style="margin-top:80px; display:flex; justify-content:space-around;">
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000; width:200px; margin:0 auto 5px;"></div>
                    <strong>Dr. Julio C. G. Quintero</strong><br>Director Académico
                </div>
                <div style="text-align:center;">
                    <p>17 de Diciembre de 2025<br>Puebla, Pue.</p>
                </div>
            </div>
            <div id="dip-stamp" class="stamp"></div>
        </div>
        
        <div style="width:100%; max-width:800px; text-align:left; margin-top:40px;">
            <h3>Bitácora de Errores</h3>
            <div id="fail-log"></div>
        </div>
    </div>

<script>
    // ESTADO GLOBAL
    let s = {
        name: "", capital: 0, 
        qIdx: 0, questions: [], score: 0, log: [],
        lifeIdx: 0,
        bizType: 0, invested: 0, units: 0, ctu: 0, price: 0, eqPrice: 0,
        factors: {T:0, K:0}, loc: {a:0, b:0}, consBudget: 0,
        failed: false,
        totalActs: 0,
        totalOk: 0,
        elastIdx: 0 // Indice para preguntas de elasticidad en Fase 6
    };

    const $ = id => document.getElementById(id);

    // REGISTRO GLOBAL DE ACCIONES
    function registerAction(ok) {
        s.totalActs++;
        if(ok) s.totalOk++;
    }

    // CONTROL DE CAPITAL
    function updateCap() {
        s.capital = Math.floor(s.capital);
        $('hud-cap').innerText = s.capital.toLocaleString();
        if(s.capital < 0) {
            s.failed = true;
            finishGame();
        }
    }

    // FEEDBACK VISUAL
    function showModal(t, m, succ, nextFunc) {
        $('m-title').innerText = t; 
        $('m-msg').innerHTML = m;
        $('m-title').style.color = succ ? 'var(--primary)' : 'var(--danger)';
        $('modal').style.display = 'flex';
        $('m-btn').onclick = function() {
            $('modal').style.display = 'none';
            if(nextFunc) nextFunc();
        };
    }

    function nextPhase(id) {
        if(s.failed) { showFail(); return; }
        document.querySelectorAll('.phase-card').forEach(c => c.classList.remove('active'));
        $(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function showFail() {
        document.querySelectorAll('.phase-card').forEach(c => c.classList.remove('active'));
        $('pFail').classList.add('active');
    }

    /* --- FASE 1: PREGUNTAS GENERALES (30 TOTALES) --- */
    const QDB = [
        {q:"El gobierno anuncia que los recursos petroleros se están agotando rápidamente, pero la necesidad de transporte sigue creciendo. ¿Qué concepto económico define esta situación?", a:["Escasez","Ahorro","Inflación"], ok:0, exp:"La escasez es el problema fundamental: recursos limitados vs necesidades ilimitadas."},
        {q:"Estás considerando vender aire puro embotellado. Actualmente, el aire en el parque es abundante y gratuito. ¿Cómo se clasifica este tipo de bien?", a:["Bien Libre","Bien Económico","Bien de Capital"], ok:0, exp:"Los bienes libres son abundantes y no tienen precio."},
        {q:"Renuncias a un empleo de $10,000 para iniciar tu negocio. Esos $10,000 que dejas de ganar son tu:", a:["Costo de Oportunidad","Costo Fijo","Utilidad"], ok:0, exp:"Valor de la mejor alternativa sacrificada."},
        {q:"Para fabricar necesitas madera y agua. En factores de producción, estos son:", a:["Tierra","Trabajo","Capital"], ok:0, exp:"Tierra agrupa los recursos naturales."},
        {q:"Adquieres un horno industrial. No es dinero, es una herramienta para producir. ¿Qué factor es?", a:["Capital","Tierra","Tecnología"], ok:0, exp:"Capital (K) son bienes que producen otros bienes."},
        {q:"Contratas operarios. Su esfuerzo físico y mental es el factor:", a:["Trabajo","Empresarial","Humano"], ok:0, exp:"Trabajo (L) es el tiempo humano dedicado a la producción."},
        {q:"Tú organizas la tierra, el trabajo y el capital, asumiendo el riesgo. ¿Qué función cumples?", a:["Empresario","Inversionista","Gerente"], ok:0, exp:"El empresario organiza los factores y asume el riesgo."},
        {q:"Mucha gente quiere tu producto, pero pocos tienen dinero. Para que exista DEMANDA real se requiere:", a:["Intención + Capacidad de Compra","Solo deseo","Necesidad"], ok:0, exp:"Demanda = Querer + Poder."},
        {q:"Subes el precio drásticamente y la cantidad de compradores disminuye. Esto confirma la:", a:["Ley de la Demanda","Ley de la Oferta","Especulación"], ok:0, exp:"A mayor Precio, menor Cantidad Demandada."},
        {q:"Al subir el precio, te sientes motivado a producir más para ganar más. Esto es la:", a:["Ley de la Oferta","Ley de la Demanda","Avaricia"], ok:0, exp:"A mayor precio, mayor cantidad ofrecida."},
        {q:"Todo lo que produces se vende, no sobra ni falta nada. El mercado está en:", a:["Equilibrio","Superávit","Déficit"], ok:0, exp:"Oferta = Demanda."},
        {q:"Si sube el precio de la mantequilla, la gente compra margarina. La margarina es un bien:", a:["Sustituto","Complementario","Inferior"], ok:0, exp:"Reemplaza la necesidad."},
        {q:"Si la gente compra más impresoras, aumenta la demanda de tinta. La tinta es un bien:", a:["Complementario","Sustituto","Suplementario"], ok:0, exp:"Se consumen juntos."},
        {q:"Un cliente valora tu producto más que otro, aunque paguen lo mismo. El valor es:", a:["Subjetivo","Objetivo","Medible"], ok:0, exp:"Depende de la apreciación individual."},
        {q:"En el flujo circular, ¿quiénes son los dueños de los factores de producción?", a:["Las Familias","El Gobierno","Las Empresas"], ok:0, exp:"Las familias venden factores a las empresas."},
        {q:"Analizas el mercado asumiendo que 'todo lo demás permanece constante'. Usas:", a:["Ceteris Paribus","Laissez Faire","Post Hoc"], ok:0, exp:"Herramienta para aislar variables."},
        {q:"El gobierno decide qué y cómo producir. Es una economía:", a:["Planificada","De Mercado","Mixta"], ok:0, exp:"Centralizada por el Estado."},
        {q:"La oferta y demanda determinan todo y hay propiedad privada. Es una economía:", a:["De Mercado","Socialista","Feudal"], ok:0, exp:"El mercado asigna recursos."},
        {q:"Tu país combina mercado libre con intervención estatal. Es una economía:", a:["Mixta","Pura","Tradicional"], ok:0, exp:"Híbrido mercado-estado."},
        {q:"Analizas la inflación y el desempleo nacional. Estás haciendo:", a:["Macroeconomía","Microeconomía","Finanzas"], ok:0, exp:"Estudio de agregados."},
        {q:"Analizas cómo gasta su sueldo una familia específica. Estás haciendo:", a:["Microeconomía","Macroeconomía","Política"], ok:0, exp:"Estudio de agentes individuales."},
        {q:"Tu servicio no se puede tocar ni almacenar. Es un:", a:["Servicio (Intangible)","Bien","Insumo"], ok:0, exp:"Intangibilidad."},
        {q:"Subes el precio 10% y la venta cae 20%. La demanda es:", a:["Elástica","Inelástica","Unitaria"], ok:0, exp:"Reacción fuerte al precio."},
        {q:"Subes el precio 10% y la venta cae solo 1%. La demanda es:", a:["Inelástica","Elástica","Perfecta"], ok:0, exp:"Poca reacción al precio."},
        {q:"Un incentivo es algo que:", a:["Motiva una conducta","Prohíbe","Es neutro"], ok:0, exp:"Estímulo para actuar."},
        {q:"Documento que da personalidad jurídica a tu empresa:", a:["Acta Constitutiva","Reglamento","Contrato"], ok:0, exp:"Acta de nacimiento empresarial."},
        // --- 4 Preguntas Adicionales para asegurar el conteo de 30 ---
        {q:"En un mercado donde TÚ eres el único vendedor, ¿en qué estructura de mercado operas?", a:["Monopolio","Competencia Perfecta","Oligopolio"], ok:0, exp:"Monopolio = Un solo vendedor."},
        {q:"Si hay pocos vendedores que dominan el mercado (como refrescos o telefonía), es un:", a:["Oligopolio","Monopolio","Monopsonio"], ok:0, exp:"Oligopolio = Pocos vendedores."},
        {q:"El pago de la renta del local no cambia aunque no produzcas nada. Es un:", a:["Costo Fijo","Costo Variable","Costo Marginal"], ok:0, exp:"No depende del nivel de producción."},
        {q:"El costo de la materia prima aumenta si produces más. Es un:", a:["Costo Variable","Costo Fijo","Costo Hundido"], ok:0, exp:"Varía proporcionalmente a la producción."}
    ];

    function startSim() {
        if(!$('in-name').value) return alert("Nombre requerido");
        s.name = $('in-name').value;
        s.questions = QDB.sort(()=>0.5-Math.random());
        s.qIdx = 0; s.capital = 0; s.score = 0;
        s.totalActs = 0; s.totalOk = 0;
        nextPhase('p1'); renderQ();
    }
    
    function renderQ() {
        if(s.qIdx >= 30 || s.qIdx >= s.questions.length) { nextPhase('p2'); renderLife(); return; }
        let q = s.questions[s.qIdx];
        let opts = q.a.map((txt,i)=>({txt, ok:i===q.ok})).sort(()=>0.5-Math.random());
        $('p1-q').innerText = `${s.qIdx+1}/30. ${q.q}`;
        $('p1-opts').innerHTML = opts.map(o=>`<button class="btn btn-outline" onclick="ansQ(${o.ok})">${o.txt}</button>`).join('');
    }
    
    function ansQ(ok) {
        let q = s.questions[s.qIdx];
        s.log.push({q:q.q, ok:ok, exp:q.exp});
        registerAction(ok);
        
        let oldCap = s.capital;
        if(ok) { s.capital+=500; s.score++; }
        
        updateCap();
        let msg = ok 
            ? `<strong>¡Respuesta Correcta!</strong><br>${q.exp}<br><br>Saldo anterior: $${oldCap}<br>Ganancia: +$500<br><strong>Nuevo Saldo: $${s.capital}</strong>` 
            : `<strong>Incorrecto.</strong><br>${q.exp}<br><br>Saldo anterior: $${oldCap}<br>Sin ganancia.<br><strong>Saldo Actual: $${s.capital}</strong>`;
            
        showModal(ok?"BIEN":"MAL", msg, ok, ()=>{s.qIdx++;renderQ();});
    }

    /* --- FASE 2: ESCENARIOS --- */
    const SCENARIOS = [
        {t:"Transporte", q:"¿Cómo ir al trabajo?", o:[{l:"Caminar ($0)",c:0},{l:"Bus ($50)",c:50},{l:"Uber ($100)",c:100}]},
        {t:"Desayuno", q:"¿Qué comer?", o:[{l:"Nada ($0)",c:0},{l:"Café ($50)",c:50},{l:"Completo ($100)",c:100}]},
        {t:"Salud", q:"Te sientes mal:", o:[{l:"Remedio casero ($0)",c:0},{l:"Farmacia ($50)",c:50},{l:"Doctor ($100)",c:100}]},
        {t:"Ropa", q:"Entrevista importante:", o:[{l:"Ropa vieja ($0)",c:0},{l:"Oferta ($50)",c:50},{l:"Traje nuevo ($100)",c:100}]},
        {t:"Tecnología", q:"Necesitas software:", o:[{l:"Pirata ($0)",c:0},{l:"Básico ($50)",c:50},{l:"Premium ($100)",c:100}]},
        {t:"Social", q:"Salida con socios:", o:[{l:"No ir ($0)",c:0},{l:"Un café ($50)",c:50},{l:"Cena ($100)",c:100}]},
        {t:"Capacitación", q:"Curso nuevo:", o:[{l:"Youtube ($0)",c:0},{l:"Udemy ($50)",c:50},{l:"Presencial ($100)",c:100}]},
        {t:"Marketing", q:"Promoción personal:", o:[{l:"Voz a voz ($0)",c:0},{l:"Volantes ($50)",c:50},{l:"Ads ($100)",c:100}]},
        {t:"Imprevisto", q:"Multa de tráfico:", o:[{l:"Ignorar ($0)",c:0},{l:"Pagar mitad ($50)",c:50},{l:"Pagar todo ($100)",c:100}]}
    ];

    function renderLife() {
        if(s.lifeIdx >= 9) { nextPhase('p3'); return; }
        let sc = SCENARIOS[s.lifeIdx];
        $('p2-story').innerText = `Decisión ${s.lifeIdx+1}: ${sc.t} - ${sc.q}`;
        $('p2-opts').innerHTML = sc.o.map(opt => 
            `<div class="card-option" onclick="doLife(${opt.c})">
                <h3>${opt.l}</h3>
            </div>`
        ).join('');
    }

    function doLife(cost) {
        let r = Math.random();
        let impact = 0;
        let msg = "";
        let good = true;

        if (cost === 0) {
            if (r < 0.5) { impact = -100; msg = "Riesgo alto fallido. Perdiste $100."; good=false; }
            else { impact = 50; msg = "¡Suerte! Ahorraste y ganaste $50 extra."; }
        } else if (cost === 50) {
            impact = -50; msg = "Decisión segura. Gasto estándar (-$50).";
        } else if (cost === 100) {
             if (r < 0.5) { impact = -150; msg = "Inversión fallida. Costo $100 + Pérdida $50."; good=false; }
             else { impact = 100; msg = "Inversión exitosa. Recuperas y ganas $100."; }
        }

        let oldCap = s.capital;
        s.capital += impact;
        updateCap();
        
        let fullMsg = `${msg}<br><br>Saldo anterior: $${oldCap}<br>Movimiento: $${impact}<br><strong>Saldo Actual: $${s.capital}</strong>`;
        
        showModal(good?"Resultado":"Problema", fullMsg, good, ()=>{ s.lifeIdx++; renderLife(); });
    }

    /* --- FASE 3: INVERSIÓN --- */
    function selectBiz(type) {
        s.bizType = type;
        if(type==0) s.ctu = 5;
        if(type==1) s.ctu = 10;
        if(type==2) s.ctu = 15;
        $('p3-invest').style.display = 'block';
        updInv();
    }
    function updInv() {
        let pct = $('inv-slider').value;
        let amount = Math.floor(s.capital * (pct/100));
        $('inv-amt').innerText = amount;
        $('inv-pct').innerText = pct;
    }
    function confirmInvest() {
        let rawInvest = parseInt($('inv-amt').innerText);
        s.units = Math.floor(rawInvest / s.ctu);
        let realCost = s.units * s.ctu;
        let change = rawInvest - realCost;
        
        s.invested = realCost;
        let oldCap = s.capital;
        s.capital -= realCost;
        
        updateCap();
        showModal("Inversión Realizada", `Compraste ${s.units} unidades a CTU $${s.ctu}.<br>Saldo Inicial: $${oldCap}<br>Costo: -$${realCost}<br><strong>Saldo Restante: $${s.capital}</strong>`, true, ()=>{
            let items = [{n:"Renta",t:"Fijo"},{n:"Sueldos",t:"Fijo"},{n:"Luz",t:"Fijo"},{n:"Insumos",t:"Variable"},{n:"Empaques",t:"Variable"}];
            $('cost-area').innerHTML = items.map((c,i)=>`<div><label>${c.n}</label><select id="c-${i}" data-ans="${c.t}"><option>Fijo</option><option>Variable</option></select></div>`).join('');
            nextPhase('p35');
        });
    }

    /* --- FASE 3.5: AUDITORÍA --- */
    function validateCosts() {
        let err=0; document.querySelectorAll('#cost-area select').forEach(s=>{if(s.value!=s.dataset.ans)err++});
        registerAction(err === 0);
        
        let oldCap = s.capital;
        if(err>0) { 
            let pen = err*500;
            s.capital -= pen; 
            updateCap();
            showModal("Multa SAT", `Detectados ${err} errores de clasificación.<br>Saldo: $${oldCap}<br>Multa: -$${pen}<br><strong>Nuevo Saldo: $${s.capital}</strong>`, false, goP4); 
        } else {
            showModal("Auditoría Aprobada", "Contabilidad correcta. No hay multas.", true, goP4);
        }
    }
    function goP4() { 
        $('p4-u').innerText=s.units; $('p4-ctu').innerText=s.ctu; 
        nextPhase('p4'); 
    }

    /* --- FASE 4: PRECIO --- */
    function calcPrice() {
        let m = parseInt($('p4-margin').value);
        if(!m || m < 0) return alert("Ingresa un margen válido.");
        s.price = Math.round(s.ctu * (1 + m/100)); 
        $('p5-price').innerText = s.price;
        $('p5-cap').innerText = s.capital;
        $('btn-expert').disabled = (s.capital < 1000);
        nextPhase('p5');
    }

    /* --- FASE 5: MERCADO --- */
    function hireExpert(h) {
        if(h && s.capital < 1000) return alert("No tienes capital suficiente ($1000).");
        // Cálculo oculto del equilibrio: Qd = 1200 - 4P, Qs = 200 + 6P -> 1000 = 10P -> P=100
        s.eqPrice = 100; 
        
        let oldCap = s.capital;
        if(h) {
            s.capital -= 1000;
            updateCap();
            // SOLO MUESTRA ECUACIONES
            $('expert-report').innerHTML = `<p>El experto entrega el análisis matemático:</p>
            <div class="math-display">
                Demanda (Qd) = 1200 - 4P<br>
                Oferta (Qs)  = 200 + 6P
            </div>
            <p><strong>Interpretación:</strong> Debes igualar Qd = Qs para encontrar el precio exacto, o pagar el ajuste automático.</p>
            <p>Saldo: $${oldCap} -> <strong>$${s.capital}</strong></p>`;
        } else {
            $('expert-report').innerHTML = `<p>Operando a ciegas. No conoces las funciones de oferta y demanda.</p>`;
        }
        $('btn-eq').disabled = (s.capital < 500);
        nextPhase('p5b');
    }

    function showManualPrice() {
        $('manual-price-area').style.display = 'block';
    }

    function marketAction(action) {
        let finalP = 0;
        let cost = 0;
        let msgDetails = "";

        if(action === 'eq') {
            if(s.capital < 500) return alert("Fondos insuficientes.");
            cost = 500;
            finalP = 100; // Precio equilibrio calculado
            msgDetails = "Se calculó P=100 (1200-4P = 200+6P). Ajuste automático realizado.";
        } else if (action === 'keep') {
            finalP = s.price;
        } else if (action === 'manual') {
            finalP = parseInt($('manual-price-in').value);
            if(!finalP) return;
        }

        let oldCap = s.capital;
        s.capital -= cost;
        
        // Ventas basadas en cercanía al equilibrio (100)
        let delta = Math.abs(finalP - 100);
        let factor = 1;
        if(delta > 5) factor = 0.5;
        if(delta > 20) factor = 0.2; // Castigo severo si está lejos
        
        let salesRev = Math.round(s.units * factor * finalP);
        s.capital += salesRev;
        updateCap();
        
        showModal("Resultado de Mercado", 
            `Precio Final: $${finalP}. (Equilibrio era $100)<br>
            ${msgDetails}<br>
            Costo Ajuste: -$${cost}<br>
            Ingresos por Ventas: +$${salesRev}<br>
            ----------------<br>
            Saldo Anterior: $${oldCap}<br>
            <strong>Saldo Actual: $${s.capital}</strong>`, 
            true, ()=>{
            setupElastPhase(); // Nueva función para iniciar la secuencia de fase 6
        });
    }

    /* --- FASE 6: SECUENCIA DE ELASTICIDADES --- */
    
    // Configuración de preguntas secuenciales para Fase 6
    const elastSequence = [
        {
            // P1: Precio (Existente)
            q: "El mercado muestra una Demanda Inelástica para tu producto. ¿Qué estrategia maximiza tus ingresos?",
            opts: [{t:"Subir Precio", ok:true}, {t:"Bajar Precio", ok:false}],
            expOk: "Correcto. En demanda inelástica, subir precios aumenta el ingreso total.",
            expFail: "Incorrecto. En demanda inelástica, bajar precios reduce el ingreso total.",
            bonus: 1000
        },
        {
            // P2: Renta (Nueva)
            q: "Se calculó una elasticidad renta negativa y al parecer los reportes económicos realizan previsiones acerca de la disminución de la renta. ¿Tu demanda aumentará o disminuirá?",
            opts: [{t:"Aumentará", ok:true}, {t:"Disminuirá", ok:false}],
            expOk: "Correcto. Si es elasticidad negativa (bien inferior), al bajar la renta, la demanda sube.",
            expFail: "Incorrecto. Los bienes inferiores aumentan su demanda cuando la gente tiene menos dinero.",
            bonus: 0 // Solo evita penalización
        },
        {
            // P3: Cruzada 1 (Nueva)
            q: "Identifica qué campaña de mkt es mejor para el Bien 1. La elasticidad cruzada es negativa y mayor que uno.",
            opts: [{t:"Campaña Conjunta", ok:true}, {t:"Campaña Diferenciación", ok:false}],
            expOk: "Correcto. Cruzada negativa indica Bienes Complementarios. Se venden mejor juntos.",
            expFail: "Incorrecto. Son complementarios, no sustitutos.",
            bonus: 0
        },
        {
            // P4: Cruzada 2 (Nueva)
            q: "Identifica qué campaña de mkt es mejor para el Bien 2. La elasticidad cruzada es positiva mayor a uno.",
            opts: [{t:"Campaña Conjunta", ok:false}, {t:"Campaña de Diferenciación", ok:true}],
            expOk: "Correcto. Cruzada positiva indica Bienes Sustitutos. Debes diferenciarte.",
            expFail: "Incorrecto. Son sustitutos (rivales), no complementarios.",
            bonus: 0
        }
    ];

    function setupElastPhase() {
        nextPhase('p6');
        s.elastIdx = 0;
        renderElastQ();
    }

    function renderElastQ() {
        if(s.elastIdx >= elastSequence.length) {
            nextPhase('p7');
            return;
        }
        let qData = elastSequence[s.elastIdx];
        let html = `<p>${qData.q}</p><div class="grid-2">`;
        qData.opts.forEach(o => {
            html += `<button class="btn btn-outline" onclick="ansElast(${o.ok})">${o.t}</button>`;
        });
        html += `</div>`;
        $('elast-area').innerHTML = html;
    }

    function ansElast(ok) {
        let qData = elastSequence[s.elastIdx];
        registerAction(ok);
        
        let oldCap = s.capital;
        let change = 0;

        if (ok) {
            change = qData.bonus; // +1000 en la primera, 0 en las demas
        } else {
            change = -1000; // Penalización solicitada
        }

        s.capital += change;
        updateCap();

        let title = ok ? "Decisión Correcta" : "Error Estratégico";
        let colorStyle = ok ? "color:var(--primary)" : "color:var(--danger)";
        let msg = `${qData.ok ? qData.expOk : qData.expFail}<br><br>
                   Saldo: $${oldCap}<br>
                   Impacto: <span style="${colorStyle}">${change > 0 ? '+'+change : change}</span><br>
                   <strong>Nuevo Saldo: $${s.capital}</strong>`;

        showModal(title, msg, ok, () => {
            s.elastIdx++;
            renderElastQ();
        });
    }


    /* --- FASE 7: UBICACIÓN Y ENTORNO --- */
    function selLoc(l,i){ s.loc[l]=i; document.querySelectorAll(`#loc-${l}1,#loc-${l}2,#loc-${l}3`).forEach(e=>e.classList.remove('selected')); $(`loc-${l}${i}`).classList.add('selected'); }
    
    function checkLocation(){
        // CDMX (1) y Veracruz (1) son las correctas
        let correct = (s.loc.a==1 && s.loc.b==1); 
        registerAction(correct); 
        
        let oldCap = s.capital;
        let change = 0;
        let msg = "";

        if(correct) {
            change = Math.round(s.capital * 0.1);
            msg = "<strong>¡Visión Estratégica Acertada!</strong><br>1. CDMX: Expectativa de alza precios (Demanda sube).<br>2. Veracruz: Prohibición de sustitutos.<br>Bonificación: +10% Capital.";
        } else {
            change = -1000; // Penalización por error
            msg = "<strong>Error de Análisis de Entorno.</strong><br>Elegiste mercados contraídos o con costos crecientes.<br>Penalización: -$1,000.";
        }
        
        s.capital += change;
        updateCap();
        showModal(correct?"Excelente":"Regular", `${msg}<br><br>Saldo: $${oldCap} -> <strong>$${s.capital}</strong>`, true, goP8);
    }
    function goP8(){ $('p8-budget').innerText = "100,000"; nextPhase('p8'); }

    /* --- FASE 8: ISOCOSTOS (100k) --- */
    function checkFactors(){
        let tVal = parseInt($('inp-t').value);
        let kVal = parseInt($('inp-k').value);
        let wVal = parseInt($('inp-w').value);

        let tCost = tVal * 20000;
        let kCost = kVal * 10000;
        let wCost = wVal * 5000;
        
        let total = tCost + kCost + wCost;
        let correct = (total === 100000);
        
        registerAction(correct);
        let oldCap = s.capital;
        
        if(!correct) {
            s.capital -= 1000; // Penalización $1000
            updateCap();
            showModal("Error Presupuestal", `Gastaste $${total} y el presupuesto es $100,000 exactos.<br>Multa: -$1,000<br><strong>Saldo: $${s.capital}</strong>`, false, goP8b);
        } else {
            s.factors.T = tVal;
            s.factors.K = kVal; 
            showModal("Eficiencia Técnica", "Has utilizado exactamente el presupuesto disponible (Isocosto).<br>Producción optimizada.", true, goP8b);
        }
    }
    function goP8b(){ nextPhase('p8b'); }
    
    function checkAdjust(){
        // RMST: 1 Tierra = 2 Maquinas (K).
        let t = parseInt($('adj-t').value);
        let k = parseInt($('adj-k').value);
        
        let neededK = (s.factors.T || 1) * 2; 
        let baseK = s.factors.K || 0;
        let targetK = baseK + neededK;
        
        let correct = (t === 0 && k === targetK);
        if(s.factors.T === 0) correct = (t===0 && k > baseK); 

        registerAction(correct);
        
        if(correct) {
            showModal("Excelente Sustitución", `Eliminaste la Tierra y compensaste con Maquinaria (Relación 2:1).<br>La producción se mantiene.`, true, goP9);
        } else {
            s.capital -= 1000; // Penalización $1000
            updateCap();
            showModal("Error Técnico", `No aplicaste correctamente la Tasa Marginal de Sustitución Técnica.<br>Debías cambiar cada Tierra por 2 Máquinas.<br>Multa: -$1,000`, false, goP9);
        }
    }
    function goP9(){ $('p9-total').innerText=s.capital; nextPhase('p9'); }

    /* --- FASE 9 --- */
    function checkDist(){
        let c=parseInt($('d-cons').value);
        let sav=parseInt($('d-save').value);
        let inv=parseInt($('d-inv').value);
        let budgetOk = !((c+sav+inv) > s.capital || c < s.capital*0.3);
        
        registerAction(budgetOk); 
        
        if(!budgetOk) { 
            s.capital-=1000; // Penalización $1000
            updateCap(); 
            s.consBudget = Math.floor((s.capital * 0.3)/20)*20; 
            return showModal("Error de Asignación", "Gasto inválido o consumo < 30%.<br>Multa: -$1,000", false, goP9b); 
        }
        
        s.consBudget = Math.floor(c/20)*20; 
        showModal("Plan Aprobado", `Presupuesto asignado a Consumo: $${s.consBudget}`, true, goP9b);
    }
    function goP9b(){ $('p9-cons-bd').innerText=s.consBudget; nextPhase('p9b'); }
    
    function checkIntercepts(){
        let p=parseInt($('r-max-p').value);
        let s_val=parseInt($('r-max-s').value);
        let correct = (p === (s.consBudget/20) && s_val === (s.consBudget/10));
        registerAction(correct);
        if(correct) showModal("Bien","Cálculo de intersecciones correcto.",true,goP9c);
        else { 
            s.capital-=1000; // Penalización $1000
            updateCap(); 
            showModal("Error","Cálculo de máximos incorrecto.<br>Multa: -$1,000",false,goP9c); 
        }
    }
    function goP9c(){ nextPhase('p9c'); }
    
    function checkBasket(){
        let tot = parseInt($('c-papas').value)*20 + parseInt($('c-soda').value)*10;
        let correct = (tot === s.consBudget);
        registerAction(correct);
        if(correct) showModal("Utilidad Maximizada","Has gastado todo tu presupuesto eficientemente.",true,goP9d);
        else { 
            s.capital-=1000; // Penalización $1000
            updateCap(); 
            showModal("Ineficiente","No agotaste el presupuesto.<br>Multa: -$1,000",false,goP9d); 
        }
    }
    function goP9d(){ nextPhase('p9d'); }
    
    function checkRMS(v){
        let correct = (v==2); // Px/Py = 20/10 = 2
        registerAction(correct);
        if(correct) { s.capital+=1000; updateCap(); showModal("Finalizado","Correcto. Costo de oportunidad: 2 refrescos.",true,finishGame); }
        else {
            s.capital-=1000; // Penalización $1000
            updateCap(); 
            showModal("Finalizado","Incorrecto.<br>Multa: -$1,000",false,finishGame);
        }
    }

    /* --- FINAL --- */
    function finishGame(failed=false) {
        if(failed || s.capital < 0) {
            s.failed = true;
            showFail();
        } else {
            nextPhase('pEnd');
        }
    }

    window.onbeforeprint = function() {
        // CÁLCULO DE CALIFICACIÓN FINAL: REGLA DE 3 SIMPLE
        let finalGrade = (s.totalActs > 0) ? ((s.totalOk / s.totalActs) * 10).toFixed(1) : "0.0";
        
        let finalCap = s.capital;
        let isPass = (!s.failed && parseFloat(finalGrade) >= 6.0);

        $('dip-name').innerText = s.name;
        $('dip-score').innerText = s.score;
        $('dip-grade').innerText = s.failed ? "0.0 (Quiebra)" : finalGrade;
        $('dip-final').innerText = finalCap.toLocaleString();
        
        let totalFails = s.totalActs - s.totalOk;
        $('dip-glob-ok').innerText = s.totalOk + " / " + s.totalActs;
        $('dip-glob-fail').innerText = totalFails;

        let stamp = $('dip-stamp');
        stamp.className = isPass ? 'stamp stamp-pass' : 'stamp stamp-fail';
        stamp.innerText = isPass ? 'APROBADO' : 'REPROBADO';

        let html = "";
        s.log.filter(l=>!l.ok).forEach((l,i)=>{
            html += `<div style="border-bottom:1px solid #ccc; padding:5px;"><strong>${l.q}</strong><br><em>${l.exp}</em></div>`;
        });
        $('fail-log').innerHTML = html || "<p>Sin errores teóricos.</p>";
    };

    function sendWhatsapp() {
        let finalGrade = (s.totalActs > 0) ? ((s.totalOk / s.totalActs) * 10).toFixed(1) : "0.0";
        
        let status = (!s.failed && parseFloat(finalGrade)>=6) ? "APROBADO" : "REPROBADO";
        let totalFails = s.totalActs - s.totalOk;
        
        let msg = `*Simulador UDAL*\nGerente: ${s.name}\nNota Final: ${finalGrade}\nCapital: $${s.capital}\nEstatus: ${status}\n\n*Resumen Global:*\nAciertos Totales: ${s.totalOk}/${s.totalActs}\nErrores Totales: ${totalFails}`;
        
        window.open(`https://wa.me/522221158614?text=${encodeURIComponent(msg)}`, '_blank');
    }

</script>
</body>
</html>